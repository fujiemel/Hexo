<div id="sea-loading-bar"></div>

<div class="sea-page-card-wrapper sea-anime-page-wrapper">
  <h1 class="sea-page-card-title">{{ page.title }}</h1>
  <div class="sea-article-content sea-doc">
    {{ render(page.content) }}
  </div>

  {% set animeList = load_config_data('bangumi') %}
  {% set stats = { total: 0, watching: 0, completed: 0, planned: 0 } %}
  {% for anime in animeList %}
    {% set stats = { 
      total: stats.total + 1, 
      watching: stats.watching + (1 if anime.status == 'watching' else 0),
      completed: stats.completed + (1 if anime.status == 'completed' else 0),
      planned: stats.planned + (1 if anime.status == 'planned' else 0)
    } %}
  {% endfor %}

  <div class="sea-anime-header">
    <div class="sea-anime-stats">
      <div class="sea-anime-stat-item">
        <span class="label">全部</span>
        <span class="value">{{ stats.total }}</span>
      </div>
      <div class="sea-anime-stat-item">
        <span class="label">正在追</span>
        <span class="value">{{ stats.watching }}</span>
      </div>
      <div class="sea-anime-stat-item">
        <span class="label">已看完</span>
        <span class="value">{{ stats.completed }}</span>
      </div>
      <div class="sea-anime-stat-item">
        <span class="label">想看</span>
        <span class="value">{{ stats.planned }}</span>
      </div>
    </div>

    <div class="sea-anime-filters">
      <button class="sea-anime-filter-btn active" data-status="all">全部</button>
      <button class="sea-anime-filter-btn" data-status="watching">正在追</button>
      <button class="sea-anime-filter-btn" data-status="completed">已看完</button>
      <button class="sea-anime-filter-btn" data-status="planned">想看</button>
    </div>
  </div>

  <div class="sea-anime-container" id="anime-grid" data-json="{{ url_for('anime/index.json') }}">
    {# Skeleton Screen #}
    {% for i in range(0, 8) %}
      <div class="sea-anime-item sea-anime-skeleton">
        <div class="sea-anime-cover-wrapper"></div>
        <div class="sea-anime-info">
          <div class="sea-anime-title"></div>
          <div class="sea-anime-meta"></div>
          <div class="sea-anime-desc"></div>
          <div class="sea-anime-progress-bar-bg"></div>
        </div>
      </div>
    {% endfor %}

    {# Initial items rendered by Hexo #}
    {% set initialCount = 12 %}
    {% for i in range(0, initialCount) %}
      {% if animeList[i] %}
        {% set anime = animeList[i] %}
        <div class="sea-anime-item" data-status="{{ anime.status }}" style="display: none; opacity: 0;">
          <div class="sea-anime-cover-wrapper">
            <img class="sea-anime-cover" data-src="{{ url_for(anime.cover) }}" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="{{ anime.title }}" loading="lazy">
            <div class="sea-anime-status-badge sea-anime-status-{{ anime.status }}">
              {% if anime.status == 'watching' %} 正在追 {% elif anime.status == 'completed' %} 已看完 {% else %} 想看 {% endif %}
            </div>
          </div>
          <div class="sea-anime-info">
            <h3 class="sea-anime-title">
              <a href="{{ anime.link }}" target="_blank">{{ anime.title }}</a>
            </h3>
            <div class="sea-anime-meta">
              <span>{{ anime.year }}</span>
              <span>{{ anime.studio }}</span>
              {% if anime.rating %}
                <span class="sea-anime-rating">⭐ {{ anime.rating }}</span>
              {% endif %}
            </div>
            {% if anime.genre %}
              <div class="sea-anime-genres">
                {% for tag in anime.genre %}
                  <span class="sea-anime-genre-tag">{{ tag }}</span>
                {% endfor %}
              </div>
            {% endif %}
            <div class="sea-anime-progress">
              <div class="sea-anime-progress-bar-bg">
                <div class="sea-anime-progress-bar" style="width: {{ (anime.progress / anime.totalEpisodes) * 100 if anime.totalEpisodes > 0 else 0 }}%"></div>
              </div>
              <div class="sea-anime-progress-text">
                进度: {{ anime.progress }} / {{ anime.totalEpisodes }}
              </div>
            </div>
            <p class="sea-anime-desc">{{ anime.description }}</p>
          </div>
        </div>
      {% endif %}
    {% endfor %}
  </div>

  <div class="sea-anime-load-more-wrapper">
    <button id="load-more-btn" class="sea-anime-load-more-btn" {% if animeList.length <= initialCount %}style="display: none;"{% endif %}>
      加载更多
    </button>
    <div id="load-more-loading" class="sea-anime-load-more-loading" style="display: none;">
      <div class="sea-loading-spinner"></div>
      <span>加载中...</span>
    </div>
  </div>
</div>

{{ js({src: 'js/anime', defer: true}) }}
